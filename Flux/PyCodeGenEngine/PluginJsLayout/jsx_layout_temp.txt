import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import _, { cloneDeep } from 'lodash';
import {
    createUILayout, updateUILayout,
    setUILayoutArrayWs, setUILayout, setSelectedUILayoutId
} from '../features/uiLayoutSlice';
import { Responsive, WidthProvider } from "react-grid-layout";
import { HashLoader } from 'react-spinners';
import { DashboardCustomize, SaveAs } from '@mui/icons-material';
import { Dialog, DialogContent, DialogActions, DialogContentText, TextField, Button, DialogTitle, Autocomplete, Paper, Box } from '@mui/material';
import { DB_ID, API_ROOT_URL, COOKIE_NAME } from '../constants';
import { getIconText } from '../utils';
import { getLayout } from '../projectSpecificUtils';
# @@protoc_insertion_point(add_imports)
import SideDrawer from './SideDrawer';
import { Icon, ToggleIcon } from './Icon';
import classes from './Layout.module.css';
import 'react-grid-layout/css/styles.css';
import 'react-resizable/css/styles.css';

const ResponsiveGridLayout = WidthProvider(Responsive);

const defaultProps = {
    layouts: {
        lg: getLayout()
    },
    breakpoints: { lg: 1200, md: 996, sm: 768, xs: 480, xxs: 0 },
    cols: { lg: 18, md: 12, sm: 6, xs: 4, xxs: 2 },
    className: 'layout',
    rowHeight: 25,
    margin: { lg: [8, 8], md: [5, 5] },
    preventCollision: false,
    allowOverlap: false,
    autoSize: false,
    isBounded: false,
    compactType: null,
    useCSSTransforms: true,
    resizeHandles: ['ne', 'se']
}

const Layout = (props) => {
    const { uiLayoutArray, uiLayout } = useSelector(state => state.uiLayout);
    const [layouts, setLayouts] = useState(() => getLayout());
    const [draggable, setDraggable] = useState(false);
    const [openSaveLayout, setOpenSaveLayout] = useState(false);
    const [openLoadLayout, setOpenLoadLayout] = useState(false);
    const [searchValue, setSearchValue] = useState('');
    const [profileId, setProfileId] = useState('');
    const [show, setShow] = useState({
        # @@protoc_insertion_point(add_widget_list)
    });
    const getAllWsDict = useRef({});
    const dispatch = useDispatch();

    const flushGetAllWs = useCallback(() => {
        /* apply get-all websocket changes */
        if (_.keys(getAllWsDict.current).length > 0) {
            dispatch(setUILayoutArrayWs(cloneDeep(getAllWsDict.current)));
            getAllWsDict.current = {};
        }
    }, [])

    useEffect(() => {
        /* get-all websocket. create a websocket client to listen to get-all interface */
        let socket = new WebSocket(`${API_ROOT_URL.replace('http', 'ws')}/get-all-ui_layout-ws`);
        socket.onmessage = (event) => {
            let updatedData = JSON.parse(event.data);
            if (Array.isArray(updatedData)) {
                updatedData.forEach(o => {
                    getAllWsDict.current[o[DB_ID]] = o;
                })
            } else if (_.isObject(updatedData)) {
                getAllWsDict.current[updatedData[DB_ID]] = updatedData;
            }
        }
        /* close the websocket on cleanup */
        return () => socket.close();
    }, [])

    useEffect(() => {
        const intervalId = setInterval(flushGetAllWs, 250);
        return () => {
            clearInterval(intervalId);
        }
    }, [])

    useEffect(() => {
        let cookie = sessionStorage.getItem(COOKIE_NAME);
        if (cookie) {
            cookie = parseInt(cookie);
            dispatch(setSelectedUILayoutId(cookie));
            let layout = uiLayoutArray.filter(uiLayout => uiLayout[DB_ID] === cookie)[0];
            if (layout) {
                dispatch(setUILayout(layout));
            }
        }
    }, [uiLayoutArray])

    useEffect(() => {
        if (uiLayout.widget_ui_data) {
            setLayouts(uiLayout.widget_ui_data);
            setProfileId(uiLayout.profile_id);
            let updatedShow = cloneDeep(show);
            Object.keys(updatedShow).map(key => {
                if (uiLayout.widget_ui_data.filter(widgetLayout => widgetLayout.i === key).length > 0) {
                    updatedShow[key] = true;
                } else {
                    updatedShow[key] = false;
                }
            })
            setShow(updatedShow);
        }
    }, [uiLayout])

    const onToggleDrag = () => {
        setDraggable(!draggable);
    }

    const onSave = () => {
        let layout;
        if (uiLayoutArray.filter(l => l.profile_id === profileId).length > 0) {
            layout = uiLayoutArray.filter(l => l.profile_id === profileId)[0];
            layout = cloneDeep(layout);
            layout.widget_ui_data = layouts;
            dispatch(updateUILayout(layout));
        } else {
            layout = { profile_id: profileId, widget_ui_data: layouts }
            dispatch(createUILayout(layout));
        }
        setOpenSaveLayout(false);
        setProfileId(layout.profile_id ? layout.profile_id : '');
    }

    const onLoad = () => {
        let layout = uiLayoutArray.filter(uiLayout => uiLayout[DB_ID] === searchValue[DB_ID])[0];
        dispatch(setUILayout(layout));
        setOpenLoadLayout(false);
        setSearchValue('');
        sessionStorage.setItem(COOKIE_NAME, searchValue[DB_ID]);
    }

    const onToggleWidget = (name) => {
        let updatedData = cloneDeep(show);
        updatedData[name] = !updatedData[name];
        # @@protoc_insertion_point(handle_update_data)
        if (!show[name]) {
            let layout = getLayoutById(name);
            setLayouts([...layouts, layout]);
        }
        setShow(updatedData);
    }

    const onLayoutChange = (updatedLayouts) => {
        updatedLayouts = updatedLayouts.map(l => {
            let layout = layouts.filter(widgetLayout => widgetLayout.i === l.i)[0];
            return { i: l.i, x: l.x, y: l.y, w: l.w, h: l.h, layout: layout.layout, enable_override: layout.enable_override, disable_override: layout.disable_override }
        })
        setLayouts(updatedLayouts);
    }

    const onSearchValueChange = (e, value) => {
        setSearchValue(value);
    }

    const onProfileIdChange = (e) => {
        setProfileId(e.target.value);
    }

    const onCloseSaveLayout = (e, reason) => {
        if (reason === 'backdropClick' || reason === 'escapeKeyDown') return;
        setOpenSaveLayout(false);
        setProfileId(uiLayout.profile_id ? uiLayout.profile_id : '');
    }

    const onCloseLoadLayout = (e, reason) => {
        if (reason === 'backdropClick' || reason === 'escapeKeyDown') return;
        setOpenLoadLayout(false);
        setSearchValue('');
    }

    const onResetLayout = () => {
        let defaultLayouts = getLayout();
        setLayouts(defaultLayouts);
        sessionStorage.removeItem(COOKIE_NAME);
        setProfileId('');
        dispatch(setUILayout({}));
        setOpenLoadLayout(false);
        let updatedShow = cloneDeep(show);
        Object.keys(updatedShow).map(key => {
            if (defaultLayouts.filter(widgetLayout => widgetLayout.i === key).length > 0) {
                updatedShow[key] = true;
            } else {
                updatedShow[key] = false;
            }
        })
        setShow(updatedShow);
    }

    const getLayoutById = (id) => {
        let layout = layouts.filter(layout => layout.i === id)[0];
        let defaultLayout = getLayout().filter(widgetLayout => widgetLayout.i === id)[0];
        if (!layout) {
            layout = uiLayout.widget_ui_data ? uiLayout.widget_ui_data.filter(widgetLayout => widgetLayout.i === id)[0] : defaultLayout;
        }
        let xMax = Math.max(...layouts.map(widgetLayout => widgetLayout.x + widgetLayout.w));
        let yMax = Math.max(...layouts.map(widgetLayout => widgetLayout.y + widgetLayout.h));
        return layout ? layout : { i: id, x: xMax, y: yMax, w: defaultLayout.w, h: defaultLayout.h, layout: defaultLayout.layout, enable_override: defaultLayout.enable_override, disable_override: defaultLayout.disable_override };
    }

    const onWidgetLayoutChange = (name, layoutType) => {
        let updatedData = cloneDeep(layouts);
        let updatedLayouts = updatedData.map(widgetLayout => {
            if (widgetLayout.i === name) {
                widgetLayout.layout = layoutType;
            }
            return widgetLayout
        });
        setLayouts(updatedLayouts);
    }

    const onWidgetOverrideChange = (name, enableOverride, disableOverride) => {
        let updatedData = cloneDeep(layouts);
        let updatedLayouts = updatedData.map(widgetLayout => {
            if (widgetLayout.i === name) {
                widgetLayout.enable_override = enableOverride;
                widgetLayout.disable_override = disableOverride;
            }
            return widgetLayout
        });
        setLayouts(updatedLayouts);
    }

    const storedCookie = sessionStorage.getItem(COOKIE_NAME);
    if (storedCookie && !uiLayout.widget_ui_data) {
        return (
            <Box className="app">
                <HashLoader />
            </Box>
        )
    }

    return (
        <Box className={classes.layout}>
            <SideDrawer draggable={draggable} onToggleDrag={onToggleDrag}>
                <Icon className={classes.icon} name="LoadLayout" title='Load Layout' onClick={() => setOpenLoadLayout(true)}>
                    <DashboardCustomize fontSize='medium' />
                </Icon>
                <Icon className={classes.icon} name="SaveLayout" title='Save Layout' onClick={() => setOpenSaveLayout(true)}>
                    <SaveAs fontSize='medium' />
                </Icon>
                # @@protoc_insertion_point(add_root_in_jsx_layout)
            </SideDrawer>
            <ResponsiveGridLayout
                {...defaultProps}
                layouts={{ lg: layouts }}
                className={classes.grid}
                isDraggable={draggable}
                isResizable={draggable}
                onLayoutChange={onLayoutChange}>

                # @@protoc_insertion_point(add_show_widget)
            </ResponsiveGridLayout>
            <Dialog
                open={openSaveLayout}
                onClose={onCloseSaveLayout}>
                <DialogTitle>Save Layout</DialogTitle>
                <DialogContent>
                    <DialogContentText className={classes.dialog_text}>
                        To save the layout, please enter profile id. If profile id already exists, layout will be overwritten.
                    </DialogContentText>
                    <TextField
                        label="Profile Id"
                        variant="standard"
                        error={uiLayoutArray.filter(layout => layout.profile_id === profileId).length > 0}
                        helperText={uiLayoutArray.filter(layout => layout.profile_id === profileId).length > 0 ? 'Profile Id already exists. Click on Save to overwrite.' : ''}
                        value={profileId}
                        onChange={onProfileIdChange}
                    />
                </DialogContent>
                <DialogActions>
                    <Button onClick={onCloseSaveLayout} autoFocus>Discard</Button>
                    <Button onClick={onSave} autoFocus>Save</Button>
                </DialogActions>
            </Dialog>
            <Dialog
                open={openLoadLayout}
                onClose={onCloseLoadLayout}>
                <DialogTitle>Load Layout</DialogTitle>
                <DialogContent>
                    <DialogContentText className={classes.dialog_text}>
                        To load the layout, select the profile id, or <Button color='error' onClick={onResetLayout}>Reset Layout</Button>
                    </DialogContentText>
                    <Autocomplete
                        options={uiLayoutArray}
                        getOptionLabel={(option) => option.profile_id ? option.profile_id : ''}
                        disableClearable
                        variant='outlined'
                        size='small'
                        value={searchValue ? searchValue : null}
                        onChange={onSearchValueChange}
                        renderInput={(params) => <TextField {...params} label="Profile id" />}
                    />
                    <DialogContentText className={classes.dialog_text}>

                    </DialogContentText>
                </DialogContent>
                <DialogActions>
                    <Button onClick={onCloseLoadLayout} autoFocus>Discard</Button>
                    <Button disabled={searchValue ? false : true} onClick={onLoad} autoFocus>Load</Button>
                </DialogActions>
            </Dialog>
        </Box>
    )
}

export default Layout;